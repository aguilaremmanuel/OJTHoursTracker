{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OJT Hours Tracker</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/circle-progress@1.2.2/dist/circle-progress.min.js"></script>
</head>
<body>

    
    <!-- <div class="header">
        <h2>Welcome to Your Profile</h2>
        <div>
            <img src="{{ profile_picture }}" alt="Profile Picture" class="profile-pic">
        </div>
    </div>
    
    <div class="profile-container">
        <div class="user-info">
            <h3>Hello, {{ name }}!</h3>
            <p>Your email: {{ email }}</p>
            <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>
    </div> -->

    <div class="tracker-main-container">

        <div class="header">
            <h1>OJT Hours Tracker</h1>
            <div class="settings">
                <div class="theme-toggle">
                    <input type="checkbox" class="checkbox" id="checkbox" checked>
                    <label for="checkbox" class="checkbox-label">
                      <i class="fas fa-moon" style="margin-right: 10px;"></i>
                      <i class="fas fa-sun"></i>
                      <span class="ball"></span>
                    </label>
                </div>
                <div class="profile-photo" id="profileToggle">
                    <img src="{{ profile_picture }}" alt="Profile Picture" class="profile-pic">
                </div>
                <div class="cont logout-button" id="logoutBtn">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    <form method="post" action="{% url 'logout' %}">
                        {% csrf_token %}
                        <button type="submit" class="logout-btn">Logout</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="activity-container">

            <div class="cont progress-container">
                <h3>My Progress</h3>
                
                <div class="progress">
                    <svg class="progress-circle" viewBox="0 0 100 100">
                        <circle class="progress-circle-bg" cx="50" cy="50" r="45" />
                        <circle class="progress-circle-fill" cx="50" cy="50" r="45" 
                                stroke-dasharray="282.743" 
                                stroke-dashoffset="282.743" />
                    </svg>
                    <div class="progress-text">
                        <span class="progress-percent">75%</span>
                        <span class="progress-label">Complete</span>
                    </div>
                </div>

                <div class="progress-bar-bg">
                    <div class="progress-bar"></div>
                </div>

                <div class="progress-hours-info">
                    <span>75 hours completed</span>
                    <span>500 hours required</span>
                </div>

                <label for="required_hours">Total Required Hours:</label>

                <input class="input hours-input" type="number" maxlength="4" min="1" name="required_hours" oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4);">
            </div>

            <div class="cont form-container">
                <form id="timeEntryForm" action="" method="POST">
                    <h3>Record Time Entry</h3>
                    <label for="date"><i class="fa-regular fa-calendar"></i> Date</label>
                    <input type="date" class="input date-input" name="date">
                    <div class="time">
                        <label for=""><i class="fa-regular fa-clock"></i> Morning</label>
                        <div class="time-container">
                            <input class="input time-input" type="time" name="time">
                            <input class="input time-input" type="time" name="time">
                            <p>Time In</p>
                            <p>Time Out</p>
                        </div>
                    </div>
                    <div class="time">
                        <label for=""><i class="fa-regular fa-clock"></i> Afternoon</label>
                        <div class="time-container">
                            <input class="input time-input" type="time" name="time">
                            <input class="input time-input" type="time" name="time">
                            <p>Time In</p>
                            <p>Time Out</p>
                        </div>
                    </div>
                    <div class="time">
                        <label for=""><i class="fa-regular fa-clock"></i> Evening (Optional)</label>
                        <div class="time-container">
                            <input class="input time-input" type="time" name="time">
                            <input class="input time-input" type="time" name="time">
                            <p>Time In</p>
                            <p>Time Out</p>
                        </div>
                    </div>
                    <button id="addTimeEntryBtn" type="button" disabled>Add Time Entry</button>
                    <div class="spinner-cont">
                        <span class="loader"></span>
                    </div>
                </form>
            </div>

        </div>

        <div class="cont time-entry-container">
            <div class="time-entry-header">
                <h3>Time Entry History</h3>
                <div>
                    <i class='bx bx-sort'></i>
                    <i class='bx bx-filter-alt'></i>
                </div>
            </div>

            <div class="instance">
                <div class="title">
                    <h3>Monday, April 14, 2025</h3>
                    <div class="action">
                        <div class="edit"><i class="fa-solid fa-pen-to-square"></i></div>
                        <div class="delete"><i class="fa-solid fa-trash"></i></div>
                    </div>
                </div>
                <div class="time">
                    <p>Morning: 10:00 - 12:00 <span>(2.00 hours)</span></p> 
                    <p>Afternoon: 13:00 - 18:00 <span>(5.00 hours)</span></p>
                    <p>Evening: 18:00 - 19:00 <span>(1.00 hour)</span></p>
                </div>
                <p class="total-hours">Total Hours: 8.00</p>
            </div>
        </div>
    </div>

    {% if not user.is_authenticated %}
        <script>window.location.href = "/";</script>
    {% endif %}
    <script>

        function getCookie(name) {

            let cookieValue = null;

            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    if (cookie.trim().startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.trim().substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function updateProgress(percent) {
            const circle = document.querySelector('.progress-circle-fill');
            const percentElement = document.querySelector('.progress-percent');
            
            // Calculate the offset (circumference = 2Ï€r)
            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            percentElement.textContent = percent + '%';
        }

        document.addEventListener('DOMContentLoaded', function () {

            updateProgress(70);

            const checkbox = document.getElementById("checkbox")
            checkbox.addEventListener("change", () => {
                document.body.classList.toggle("light-mode");
            });

            const profile = document.getElementById('profileToggle');
            const logoutBtn = document.getElementById('logoutBtn');

            profile.addEventListener('click', function () {
                logoutBtn.classList.toggle('show');
            });

            document.addEventListener('click', function (e) {
                if (!profile.contains(e.target) && !logoutBtn.contains(e.target)) {
                    logoutBtn.classList.remove('show');
                }
            });

            const dateInput = document.querySelector('input[name="date"]');
            const addTimeEntryBtn = document.getElementById('addTimeEntryBtn');
            const timeEntryForm = document.getElementById('timeEntryForm');

            function validateForm() {
                const dateFilled = dateInput.value.trim() !== '';

                // Group time inputs into sets of two (Time In, Time Out)
                const timeContainers = document.querySelectorAll('.time-container');
                let atLeastOneCompletePair = false;

                timeContainers.forEach(container => {
                    const times = container.querySelectorAll('input[type="time"]');
                    if (times.length === 2) {
                        const timeIn = times[0].value.trim();
                        const timeOut = times[1].value.trim();
                        if (timeIn !== '' && timeOut !== '') {
                            atLeastOneCompletePair = true;
                        }
                    }
                });

                addTimeEntryBtn.disabled = !(dateFilled && atLeastOneCompletePair);

                if(dateFilled && atLeastOneCompletePair) {
                    addTimeEntryBtn.style = 'opacity: 100%! important';
                }
            }

            // Attach listener to all time inputs and the date input
            document.querySelectorAll('input[type="time"], input[name="date"]').forEach(input => {
                input.addEventListener('input', validateForm);
            });

            // Initial check
            validateForm();

            addTimeEntryBtn.addEventListener('click', function() {

                const spinnerCont = document.querySelector('.spinner-cont');
                addTimeEntryBtn.style.display = 'none';
                spinnerCont.style.display = 'flex';

                const formData = new FormData(timeEntryForm);

                const timeFields = timeEntryForm.querySelectorAll('input[type="time"]');
                const payload = {
                    date: formData.get('date'),
                    morning_in: timeFields[0].value || null,
                    morning_out: timeFields[1].value || null,
                    afternoon_in: timeFields[2].value || null,
                    afternoon_out: timeFields[3].value || null,
                    evening_in: timeFields[4].value || null,
                    evening_out: timeFields[5].value || null
                };

                fetch('/api/time-entry/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(payload)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.message) {
                        console.log(data.message);
                        timeEntryForm.reset();
                        setTimeout(() => {
                            addTimeEntryBtn.style.display = 'block';
                            spinnerCont.style.display = 'none';
                        }, 1000);

                    } else {
                        console.error(data);
                        alert('Failed to record time entry.');
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Something went wrong.');
                });

            });

        });

      </script>
</body>
</html>